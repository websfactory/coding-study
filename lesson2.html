<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ëª¬ìŠ¤í„°ë¥¼ í”¼í•´ ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ì•„ë¼! ğŸ’</title>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }

    body {
      background-color: #f5f7fa;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      overflow: hidden;
      height: 100%;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      position: relative;
    }
    
    html {
      height: 100%;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
    }

    /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì„¤ì • */
    :root {
      height: 100dvh;
      height: -webkit-fill-available;
    }
    
    /* CSS ë³€ìˆ˜ë¡œ ë·°í¬íŠ¸ ë†’ì´ ê´€ë¦¬ */
    :root {
      --vh: 1vh;
    }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .container {
      display: flex;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100);
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      overflow: hidden;
      position: relative;
    }

    /* ìœ„ì¹˜ ë°°ê²½ */
    .location-bg {
      width: 100%;
      height: 180px;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      position: relative;
      transition: all 1s ease;
      border-bottom: 5px solid #64B5F6;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* ìºë¦­í„° ìŠ¤íƒ€ì¼ */
    .character {
      font-size: 4rem;
      animation: bounce 2s infinite;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      z-index: 5;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* ìœ„ì¹˜ íƒ€ì´í‹€ */
    .location-title {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ì±„íŒ… ì˜ì—­ */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 85px; /* ì…ë ¥ì°½ ë†’ì´ + ì—¬ìœ  ê³µê°„ */
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 4px;
      position: relative;
      word-break: break-word;
      animation: fadeIn 0.3s forwards;
    }

    /* ë©”ì‹œì§€ í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ì½”ë”” ë©”ì‹œì§€ */
    .codi-message {
      align-self: flex-start;
      background-color: #E3F2FD;
      border-bottom-left-radius: 5px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* í”Œë ˆì´ì–´ ë©”ì‹œì§€ */
    .player-message {
      align-self: flex-end;
      background-color: #E8F5E9;
      border-bottom-right-radius: 5px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ */
    .sender-name {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    /* ì…ë ¥ ì˜ì—­ */
    .input-container {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
      background-color: white;
      border-top: 1px solid #e1e4e8;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      /* ë¸Œë¼ìš°ì € ë°” ë†’ì´ ê³ ë ¤ */
      bottom: calc(0px + (100vh - 100%));
      /* êµ¬ë²„ì „ iOS ì§€ì› */
      padding-bottom: calc(12px + constant(safe-area-inset-bottom, 45px));
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
    }

    /* ì…ë ¥ì°½ */
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e1e4e8;
      border-radius: 24px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
    }

    .message-input:focus {
      border-color: #64B5F6;
    }

    .message-input:disabled {
      background-color: #f5f7fa;
      cursor: not-allowed;
    }

    /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .btn {
      border: none;
      background-color: #2196F3;
      color: white;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      transition: background-color 0.3s, transform 0.2s;
      outline: none;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ì œì¶œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
    @media (max-width: 768px) {
      #sendBtn {
        display: none;
      }
    }

    .btn:hover {
      background-color: #1976D2;
      transform: scale(1.05);
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn:disabled {
      background-color: #B0BEC5;
      cursor: not-allowed;
      transform: none;
    }

    /* ë°±íŒ© ë²„íŠ¼ */
    .backpack-btn {
      background-color: #4CAF50;
    }

    .backpack-btn:hover {
      background-color: #388E3C;
    }

    /* ì„ íƒì§€ ìŠ¤íƒ€ì¼ */
    .options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    .option-btn {
      background-color: #E8EAF6;
      color: #3F51B5;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      text-align: left;
      transition: background-color 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      font-weight: 500;
    }

    .option-btn:hover {
      background-color: #C5CAE9;
      transform: translateX(5px);
    }

    .option-btn:active {
      transform: translateX(2px);
    }

    /* ë°±íŒ© ì˜ì—­ */
    .backpack-container {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom, 20px));
      right: 15px;
      background-color: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 10;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .backpack-container.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    .backpack-title {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #333;
    }

    .backpack-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .item {
      background-color: #FFF9C4;
      color: #F57F17;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 0.9rem;
      animation: popIn 0.4s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @keyframes popIn {
      0% { transform: scale(0); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .empty-bag {
      color: #9E9E9E;
      font-style: italic;
    }

    /* íŒíŠ¸ ìŠ¤íƒ€ì¼ */
    .hint {
      background-color: #FFF8E1;
      border-left: 4px solid #FFC107;
      padding: 12px 16px;
      margin-top: 6px;
      margin-bottom: 10px;
      border-radius: 4px;
      animation: fadeIn 0.5s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .error-message {
      color: #D32F2F;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      background-color: #FFEBEE;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    /* ì„±ê³µ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .success-message {
      color: #388E3C;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      background-color: #E8F5E9;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: popIn 0.5s;
    }

    /* ë¡œë”© íš¨ê³¼ */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background-color: #E3F2FD;
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 6px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #64B5F6;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* ì •ë‹µ ì…ë ¥ ìŠ¤íƒ€ì¼ */
    .correct-answer {
      color: #388E3C;
      font-weight: bold;
    }

    /* ì½”ë“œ íƒœê·¸ ìŠ¤íƒ€ì¼ */
    code {
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: #d32f2f;
      font-weight: bold;
    }

    /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .progress-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.3);
    }

    .progress-bar {
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.5s ease;
    }
    
    /* Safari ë²„ê·¸ í•´ê²°ì„ ìœ„í•œ ë¹ˆ ê³ ì • ìš”ì†Œ */
    .safari-fix {
      position: fixed;
      top: 0;
      left: 0;
      width: 1px;
      height: 1px;
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .input-container {
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
        bottom: env(safe-area-inset-bottom, 0);
      }
    }
    
    /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì§€ì› ë¸Œë¼ìš°ì € */
    @supports (height: 100dvh) {
      .container {
        min-height: 100dvh;
        height: 100dvh;
      }
    }
    
    /* ì‘ì€ í™”ë©´ì—ì„œ ë°±íŒ© ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
    @media (max-height: 600px) {
      .backpack-container {
        bottom: calc(120px + env(safe-area-inset-bottom, 45px));
      }
      
      .chat-container {
        padding-bottom: 105px;
      }
    }
    
    /* iOS í‚¤ë³´ë“œ ëŒ€ì‘ */
    @supports (-webkit-touch-callout: none) {
      .input-container {
        position: fixed;
        bottom: 0;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform;
      }
    }
  </style>
</head>
<body>
  <!-- Safari ë²„ê·¸ í•´ê²°ì„ ìœ„í•œ ë¹ˆ ê³ ì • ìš”ì†Œ -->
  <div class="safari-fix"></div>
  
  <div class="container">
    <!-- ìœ„ì¹˜ ë°°ê²½ ì˜ì—­ -->
    <div class="location-bg" id="locationBg">
      <div class="character" id="locationCharacter">ğŸ¤–</div>
      <div class="location-title" id="locationTitle">ğŸ‘‹ íŒŒì´ì¬ íƒí—˜ëŒ€ì˜ ì‹ ë¹„í•œ ì—¬í–‰</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <div class="chat-container" id="chatContainer"></div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-container">
      <input type="text" class="message-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button class="btn" id="sendBtn">ğŸ“¤</button>
      <button class="btn backpack-btn" id="backpackBtn">ğŸ’</button>
    </div>
  </div>

  <!-- ë°±íŒ© ì»¨í…Œì´ë„ˆ -->
  <div class="backpack-container" id="backpackContainer">
    <div class="backpack-title">ğŸ’ ë‚´ê°€ë°©</div>
    <div class="backpack-items" id="backpackItems">
      <div class="empty-bag">ê°€ë°©ì´ ë¹„ì–´ìˆì–´ìš”</div>
    </div>
  </div>

  <script>
    // ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì„¤ì • - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë°” ëŒ€ì‘
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    // ì´ˆê¸° ì„¤ì • ë° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', setViewportHeight);
    
    // Visual Viewport API ì‚¬ìš© (ì§€ì›í•˜ëŠ” ê²½ìš°)
    if ('visualViewport' in window) {
      window.visualViewport.addEventListener('resize', () => {
        const height = window.visualViewport.height;
        const bottomOffset = window.innerHeight - height;
        const inputContainer = document.querySelector('.input-container');
        if (inputContainer) {
          inputContainer.style.bottom = `${bottomOffset}px`;
        }
      });
    }
    
    // DOM ìš”ì†Œ
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const backpackBtn = document.getElementById('backpackBtn');
    const backpackContainer = document.getElementById('backpackContainer');
    const backpackItems = document.getElementById('backpackItems');
    const locationBg = document.getElementById('locationBg');
    const locationTitle = document.getElementById('locationTitle');
    const locationCharacter = document.getElementById('locationCharacter');
    const progressBar = document.getElementById('progressBar');

    // ê²Œì„ ìƒíƒœ ê°ì²´
    const game = {
      playerName: '',
      currentStage: 'intro',
      bag: [],
      isTyping: false,
      lastPoppedItem: null, // popìœ¼ë¡œ êº¼ë‚¸ ì•„ì´í…œ ì„ì‹œ ì €ì¥
      
      // ë°±íŒ© ì—…ë°ì´íŠ¸
      updateBackpack: function() {
        if (this.bag.length === 0) {
          backpackItems.innerHTML = '<div class="empty-bag">ê°€ë°©ì´ ë¹„ì–´ìˆì–´ìš”</div>';
          return;
        }

        backpackItems.innerHTML = '';
        this.bag.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'item';
          const emoji = itemEmojis[item] || 'â“'; 
          itemElement.textContent = `${emoji} ${item}`;
          backpackItems.appendChild(itemElement);
        });
      },
      
      // ì½”ë”” ë©”ì‹œì§€ ì¶”ê°€
      addCodiMessage: function(text, callback) {
        if (this.isTyping) {
          return;
        }
        
        this.isTyping = true;
        messageInput.disabled = true; 
        sendBtn.disabled = true; 
        
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        chatContainer.appendChild(typingIndicator);
        scrollToBottom();
        
        setTimeout(() => {
          if (typingIndicator.parentNode === chatContainer) {
            chatContainer.removeChild(typingIndicator);
          }
          
          const messageElement = document.createElement('div');
          messageElement.className = 'message codi-message';
          
          const senderElement = document.createElement('div');
          senderElement.className = 'sender-name';
          senderElement.textContent = 'ì½”ë”” ğŸ¤–';
          
          const textElement = document.createElement('div');
          textElement.innerHTML = ''; 
          
          messageElement.appendChild(senderElement);
          messageElement.appendChild(textElement);
          chatContainer.appendChild(messageElement);
          
          let i = 0;
          const typingSpeed = 20; 
          
          const typeChar = () => {
            if (i < text.length) {
              if (text.substring(i).startsWith('<br>')) {
                textElement.innerHTML += '<br>';
                i += 4; 
              } else {
                textElement.innerHTML += text.charAt(i);
                i++;
              }
              scrollToBottom();
              setTimeout(typeChar, typingSpeed);
            } else {
              this.isTyping = false;
              if (!this.isOptionStage(this.currentStage) && !(callback && this.isCallbackLeadingToOptions(this.currentStage))) {
                 if(this.currentStage !== 'ending_treasure' && this.currentStage !== 'codi_farewell_soon') { 
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                 }
              }
              if (callback) {
                setTimeout(callback, 300); 
              }
            }
          };
          
          typeChar();
        }, 500); 
      },

      isOptionStage: function(stageName) {
        const optionStages = ['intro_confirm_start', 'ending_treasure']; 
        return optionStages.includes(stageName);
      },

      isCallbackLeadingToOptions: function(stageName) {
        return false;
      },
      
      addPlayerMessage: function(text) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message player-message';
        
        const senderElement = document.createElement('div');
        senderElement.className = 'sender-name';
        senderElement.textContent = this.playerName || 'íƒí—˜ê°€ ğŸŒŸ'; 
        
        const textElement = document.createElement('div');
        textElement.textContent = text;
        
        messageElement.appendChild(senderElement);
        messageElement.appendChild(textElement);
        chatContainer.appendChild(messageElement);
        
        scrollToBottom();
      },
      
      addOptions: function(options, correctOption, nextStageOrCallback) {
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-container';
        
        messageInput.disabled = true; 
        messageInput.placeholder = 'ì„ íƒì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”...';
        sendBtn.disabled = true;
        
        options.forEach(optionText => { 
          const optionBtn = document.createElement('button');
          optionBtn.className = 'option-btn';
          optionBtn.textContent = optionText;
          
          optionBtn.addEventListener('click', () => {
            document.querySelectorAll('.option-btn').forEach(btn => {
              btn.disabled = true;
              btn.style.opacity = 0.5;
            });
            
            optionBtn.style.opacity = 1;
            optionBtn.style.backgroundColor = '#C5CAE9'; 
            
            this.addPlayerMessage(optionText);
            
            setTimeout(() => {
              if (optionsContainer.parentNode === chatContainer) { 
                  chatContainer.removeChild(optionsContainer);
              }
              
              if (optionText === correctOption) {
                if (typeof nextStageOrCallback === 'string') {
                  this.showSuccess('ì¢‹ì•„! ì„ íƒ ì™„ë£Œ!'); 
                  setTimeout(() => this.goToStage(nextStageOrCallback), 1000);
                } else if (typeof nextStageOrCallback === 'function') {
                   this.showSuccess('ì¢‹ì•„! ì„ íƒ ì™„ë£Œ!');
                   setTimeout(nextStageOrCallback.bind(this, optionText), 1000); // ì½œë°±ì— ì„ íƒëœ ì˜µì…˜ ì „ë‹¬ ë° this ë°”ì¸ë”©
                }
              } else {
                this.showDetailedError("ìŒ... ê·¸ ì„ íƒì€ ì•„ë‹Œ ê²ƒ ê°™ì•„. ë‹¤ì‹œ í•œë²ˆ ê³¨ë¼ë³¼ê¹Œ?", this.currentStage); 
              }
            }, 500);
          });
          
          optionsContainer.appendChild(optionBtn);
        });
        
        chatContainer.appendChild(optionsContainer);
        scrollToBottom();
      },
      
      handleCustomInput: function(input, correctAnswerOrValidator, nextStageOrCallback, failureMessage) {
        let isValid = false;
        let validationResult = { success: false };

        if (typeof correctAnswerOrValidator === 'function') {
            validationResult = correctAnswerOrValidator(input);
            isValid = validationResult.success;
        } else if (typeof correctAnswerOrValidator === 'string') {
            // ê³µë°±ì„ ë¬´ì‹œí•˜ê³  ë¹„êµí•˜ì—¬ ë„ì–´ì“°ê¸° ì°¨ì´ë¥¼ í—ˆìš©
            const normalizeString = (str) => str.replace(/\s+/g, '').toLowerCase();
            if (normalizeString(input) === normalizeString(correctAnswerOrValidator)) {
                isValid = true;
            }
        }

        if (isValid) {
          const commandSuccessful = this.executeCommand(input); 
          if (commandSuccessful === false) { 
            if (failureMessage) {
                 this.showDetailedError(failureMessage, this.currentStage);
            } else if (validationResult && validationResult.message) {
                 this.showDetailedError(validationResult.message, this.currentStage);
            }
            return; 
          }
          this.showSuccess(); // executeCommand ì„±ê³µ í›„ ë©”ì‹œì§€ í‘œì‹œ

          if (typeof nextStageOrCallback === 'string') {
            setTimeout(() => this.goToStage(nextStageOrCallback), 1000);
          } else if (typeof nextStageOrCallback === 'function') {
            setTimeout(() => nextStageOrCallback(this.lastPoppedItem), 1000); 
          }
        } else {
          let errMsg = failureMessage || (validationResult && validationResult.message) || "ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì¤„ë˜? ğŸ§";
          this.showDetailedError(errMsg, this.currentStage); 
        }
      },
      
      executeCommand: function(command) {
        try {
            const appendRegex = /^ë‚´ê°€ë°©\.append\(\s*['"](.+?)['"]\s*\)$/;
            const removeRegex = /^ë‚´ê°€ë°©\.remove\(\s*['"](.+?)['"]\s*\)$/;
            const insertRegex = /^ë‚´ê°€ë°©\.insert\(\s*(\d+)\s*,\s*['"](.+?)['"]\s*\)$/;
            const popRegex = /^(?:(\w+)\s*=\s*)?ë‚´ê°€ë°©\.pop\(\s*(\d+)\s*\)$/;
            const lenRegex = /^len\(\s*ë‚´ê°€ë°©\s*\)$/;

            let match;

            if ((match = command.match(appendRegex))) {
                const item = match[1];
                this.bag.push(item);
                this.updateBackpack();
                // this.addCodiMessage(`âœ… '${item}'(ì„)ë¥¼ ê°€ë°©ì— ë„£ì—ˆì–´!`); // ì„±ê³µ ë©”ì‹œì§€ëŠ” handleCustomInputì—ì„œ í†µí•©
            } else if ((match = command.match(removeRegex))) {
                const item = match[1];
                const itemIndex = this.bag.indexOf(item);
                if (itemIndex > -1) {
                    this.bag.splice(itemIndex, 1);
                    this.updateBackpack();
                } else {
                    this.showDetailedError(`âš ï¸ '${item}'(ì€)ëŠ” ê°€ë°©ì— ì—†ëŠ” ê²ƒ ê°™ì•„. ë°±íŒ©ì„ í™•ì¸í•´ë³¼ê¹Œ?`, this.currentStage);
                    return false; 
                }
            } else if ((match = command.match(insertRegex))) {
                const index = parseInt(match[1]);
                const item = match[2];
                if (index >= 0 && index <= this.bag.length) { 
                    this.bag.splice(index, 0, item);
                    this.updateBackpack();
                    // this.addCodiMessage(`âœ… '${item}'(ì„)ë¥¼ ${index}ë²ˆ ì¹¸ì— ë„£ì—ˆì–´! (í˜„ì¬ ê°€ë°©: ${JSON.stringify(this.bag).replace(/","/g, "', '")})`);
                } else {
                    this.showDetailedError(`âš ï¸ ${index}ë²ˆ ì¹¸ì€ ì—†ëŠ” ìœ„ì¹˜ì•¼. 0ë¶€í„° ${this.bag.length - 1}ê¹Œì§€ì˜ ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.`, this.currentStage);
                    return false; 
                }
            } else if ((match = command.match(popRegex))) {
                const variableName = match[1]; // ë³€ìˆ˜ ì´ë¦„ (ì˜ˆ: ì„ ë¬¼)
                const index = parseInt(match[2]); // ì¸ë±ìŠ¤

                if (index >= 0 && index < this.bag.length) {
                    const poppedItem = this.bag.splice(index, 1)[0];
                    this.lastPoppedItem = poppedItem; 
                    this.updateBackpack();
                    // this.addCodiMessage(`âœ… ${index}ë²ˆ ì¹¸ì—ì„œ '${poppedItem}'(ì„)ë¥¼ êº¼ëƒˆì–´! ${(variableName ? `'${variableName}' ë³€ìˆ˜ì— '${poppedItem}'(ì´)ê°€ ë‹´ê²¼ì–´!` : '')}`);
                } else {
                     if (this.bag.length === 0) {
                        this.showDetailedError("âš ï¸ ê°€ë°©ì´ ë¹„ì–´ ìˆì–´ì„œ ì•„ë¬´ê²ƒë„ êº¼ë‚¼ ìˆ˜ ì—†ì–´!", this.currentStage);
                    } else {
                        this.showDetailedError(`âš ï¸ ${index}ë²ˆ ì¹¸ì€ ì—†ëŠ” ìœ„ì¹¸ì•¼. 0ë¶€í„° ${this.bag.length - 1}ê¹Œì§€ì˜ ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´.`, this.currentStage);
                    }
                    return false; 
                }
            } else if (lenRegex.test(command)) {
                this.addCodiMessage(`â„¹ï¸ ê°€ë°©ì—ëŠ” í˜„ì¬ ${this.bag.length}ê°œì˜ ì•„ì´í…œì´ ìˆì–´!`);
            } else {
                // ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œ ë‹¨ìˆœ ë¬¸ìì—´(ì„ íƒì§€ ë“±)ì¼ ê²½ìš°, ë˜ëŠ” ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´.
                // handleCustomInputì—ì„œ ì´ë¯¸ ì˜¤ë¥˜ ì²˜ë¦¬ë¥¼ í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” true ë°˜í™˜.
                return true; 
            }
            return true; 
        } catch (error) {
            console.error("ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:", error);
            this.showDetailedError("ì•—! ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” ì¤‘ì— ë¬¸ì œê°€ ìƒê²¼ì–´. ë‹¤ì‹œ ì‹œë„í•´ ì¤„ë˜?", this.currentStage);
            return false; 
        }
      },
      
      showSuccess: function(message = 'âœ… ì •í™•í•´! ì˜í–ˆì–´!') { 
        const successElement = document.createElement('div');
        successElement.className = 'success-message';
        successElement.innerHTML = message; 
        chatContainer.appendChild(successElement);
        scrollToBottom();
      },
      
      showDetailedError: function(errorMessage, stageToRetry) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.innerHTML = `ğŸ¤· ${errorMessage}`; 
        chatContainer.appendChild(errorElement);
        scrollToBottom();

        messageInput.disabled = false;
        messageInput.placeholder = 'ë‹¤ì‹œ ì…ë ¥í•´ë³´ì„¸ìš”...';
        sendBtn.disabled = false;
      },

      showError: function() { 
        this.showDetailedError('âŒ ì•„ì‰½ê²Œë„ í‹€ë ¸ì–´! ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”?', this.currentStage);
      },
      
      goToStage: function(stageName) {
        this.currentStage = stageName;
        messageInput.disabled = false; 
        messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
        sendBtn.disabled = false;
        
        switch(stageName) {
          case 'intro':
            updateLocation('start', 0); 
            this.addCodiMessage('ì•ˆë…•! ğŸ‘‹ ë‹¤ì‹œ ë§Œë‚˜ ë°˜ê°€ì›Œ! ì§€ë‚œë²ˆì—” íŒŒì´ì¬ ë¦¬ìŠ¤íŠ¸ì˜ ê¸°ì´ˆë¥¼ ë°°ì› ì—ˆì§€.<br>ì´ë²ˆì—” "ëª¬ìŠ¤í„°ë¥¼ í”¼í•´ ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ì•„ë¼! ğŸ’" ëª¨í—˜ì„ ë– ë‚  ê±°ì•¼.<br>ì‹œì‘í•˜ê¸° ì „ì—, ë„¤ ì´ë¦„ì´ ë­ì˜€ë”ë¼? ë‹¤ì‹œ í•œë²ˆ ì•Œë ¤ì¤„ë˜?', () => {
              messageInput.placeholder = 'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”...';
            });
            break;
            
          case 'intro_confirm_start': 
            updateLocation('adventure_start', 5); 
            this.addCodiMessage(`${this.playerName || 'íƒí—˜ê°€'}ì•„(ì•¼), ì •ë§ ë°˜ê°€ì›Œ! ğŸ¤©<br>ì´ë²ˆ ëª¨í—˜ì—ì„œë„ ë§ˆë²• ê°€ë°© 'ë‚´ê°€ë°©'ì„ ì‚¬ìš©í•  ê±°ì•¼. <code>ë‚´ê°€ë°© = []</code> ì´ë ‡ê²Œ ë¹„ì–´ìˆëŠ” ìƒíƒœë¡œ ì‹œì‘í•˜ì!`, () => {
              this.bag = []; 
              this.updateBackpack();
              this.addCodiMessage('ì, ê·¸ëŸ¼ ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ìœ¼ëŸ¬ ì¶œë°œí•  ì¤€ë¹„ ëë‹ˆ?', () => {
                this.addOptions(
                  ['ë„¤, ì¤€ë¹„ëì–´ìš”! ë³´ë¬¼ì„ ì°¾ìœ¼ëŸ¬ ê°€ìš”! ğŸš€'], 
                  'ë„¤, ì¤€ë¹„ëì–´ìš”! ë³´ë¬¼ì„ ì°¾ìœ¼ëŸ¬ ê°€ìš”! ğŸš€',
                  'stage1_forest_intro'
                );
              });
            });
            break;
            
          case 'stage1_forest_intro':
            updateLocation('forest', 10); 
            this.addCodiMessage('ì¢‹ì•„! ìš°ë¦¬ëŠ” "ì†ì‚­ì´ëŠ” ìˆ²"ì— ë„ì°©í–ˆì–´. ğŸŒ²<br>ì´ê³³ì„ ì•ˆì „í•˜ê²Œ ì§€ë‚˜ê°€ë ¤ë©´ ì•„ì´í…œì´ í•„ìš”í•´.', () => {
              this.addCodiMessage("'ë“±ë¶ˆ'ë¡œ ê¸¸ì„ ë°íˆê³ , 'ì—´ë§¤'ë¡œ í—ˆê¸°ë¥¼ ë‹¬ë˜ì•¼ í•´.<br>ë¨¼ì € 'ë“±ë¶ˆ'ì„ ê°€ë°©ì— ë„£ì–´ë³¼ê¹Œ?<br>(íŒíŠ¸: <code>ë‚´ê°€ë°©.append(\'ì•„ì´í…œì´ë¦„\')</code> ê¸°ì–µë‚˜ì§€? 'a'ë¡œ ì‹œì‘í•´!)", () => {
                messageInput.placeholder = "append ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”...";
              });
            });
            break;

          case 'stage1_forest_append_berry':
            this.addCodiMessage("ğŸ’¡ 'ë“±ë¶ˆ'ì´ ê°€ë°©ì— ì™! (ë°±íŒ© UI í™•ì¸!)<br>ë¡œë¸”ë¡ìŠ¤ ê²Œì„ì—ì„œ ì¸ë²¤í† ë¦¬ì— ì•„ì´í…œ ë„£ëŠ” ê±°ë‘ ë˜‘ê°™ì§€? ğŸ˜‰", () => {
              this.addCodiMessage("ì´ì œ 'ì—´ë§¤'ë„ ê°€ë°©ì— ë„£ì–´ë³´ì! ê°™ì€ ë°©ë²•ì´ì•¼.", () => {
                messageInput.placeholder = "append ëª…ë ¹ì–´ë¡œ ì—´ë§¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”...";
              });
            });
            break;

          case 'stage1_forest_len':
            this.addCodiMessage("ğŸ“ 'ì—´ë§¤'ë„ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€! ê°€ë°©ì´ ë“ ë“ í•´ì¡ŒëŠ”ê±¸?<br>ì§€ê¸ˆ ê°€ë°©ì— ì•„ì´í…œì´ ì´ ëª‡ ê°œ ìˆëŠ”ì§€ í™•ì¸í•´ë³¼ê¹Œ?", () => {
              this.addCodiMessage("(íŒíŠ¸: ì „ì²´ ê°œìˆ˜ëŠ” 'l'ë¡œ ì‹œì‘í•˜ëŠ” ì§§ì€ ëª…ë ¹ì–´! <code>len(ë‚´ê°€ë°©)</code> ê¸°ì–µë‚˜ì§€?)", () => {
                messageInput.placeholder = "len ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...";
              });
            });
            break;

          case 'stage2_cave_intro':
            updateLocation('cave_bridge', 30); 
            this.addCodiMessage(`ë§ì•„! ê°€ë°©ì—ëŠ” ì´ ${this.bag.length}ê°œì˜ ì•„ì´í…œì´ ìˆì–´!<br><code>len()</code> ëª…ë ¹ì–´ëŠ” ë‚˜ì¤‘ì— ë¡œë¸”ë¡ìŠ¤ì—ì„œ ì¹œêµ¬ ëª©ë¡ ìˆ˜ë‚˜ ìŠ¤í‚¬ ê°œìˆ˜ ì…€ ë•Œë„ ìœ ìš©í•  ê±°ì•¼!`, () => {
              this.addCodiMessage("ìœ¼ì•…! ğŸ˜± ì € ì•ì— 'í”ë“¤ë¦¬ëŠ” ë™êµ´ ë‹¤ë¦¬'ê°€ ë‚˜íƒ€ë‚¬ì–´!<br>ë‹¤ë¦¬ê°€ ë„ˆë¬´ ë‚¡ì•„ì„œ, ê°€ë°©ì—ì„œ ê°€ì¥ ë¬´ê±°ì›Œ ë³´ì´ëŠ” 'ë“±ë¶ˆ'ì„ ì ì‹œ ë‚´ë ¤ë†“ê³  ê°€ì•¼ê² ì–´.", () => {
                this.addCodiMessage("ê°€ë°©ì—ì„œ ì•„ì´í…œì„ ì—†ì•¨ ë•ŒëŠ” ì–´ë–¤ ëª…ë ¹ì–´ë¥¼ ì¼ë”ë¼?<br>(íŒíŠ¸: 'r'ë¡œ ì‹œì‘í•´! <code>ë‚´ê°€ë°©.remove(\'ì•„ì´í…œì´ë¦„\')</code> í˜•ì‹ì´ì•¼!)", () => {
                  messageInput.placeholder = "remove ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”...";
                });
              });
            });
            break;
          
          case 'stage2_cave_after_remove':
            this.addCodiMessage("íœ´, ë‹¤í–‰ì´ë‹¤! ğŸ’¡ 'ë“±ë¶ˆ'ì„ ë‚´ë ¤ë†“ìœ¼ë‹ˆ ê°€ë°©ì´ ê°€ë²¼ì›Œì ¸ì„œ ì•ˆì „í•˜ê²Œ ê±´ë„œì–´!", () => {
              this.addCodiMessage("ì§€ê¸ˆ ê°€ë°©ì—” ë­ê°€ ë‚¨ì•˜ëŠ”ì§€ <code>len(ë‚´ê°€ë°©)</code>ìœ¼ë¡œ ë‹¤ì‹œ í™•ì¸í•´ë³¼ê¹Œ?", () => {
                messageInput.placeholder = "len ëª…ë ¹ì–´ë¡œ ê°œìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”...";
              });
            });
            break;

          case 'stage3_altar_intro':
            updateLocation('altar', 50); 
            if (!this.bag.includes('ë¬¼ì˜ ìˆ˜ì •')) this.bag.push('ë¬¼ì˜ ìˆ˜ì •');
            if (!this.bag.includes('ë°”ëŒì˜ ìˆ˜ì •')) this.bag.push('ë°”ëŒì˜ ìˆ˜ì •');
            this.updateBackpack();

            this.addCodiMessage(`ì¢‹ì•„, ê°€ë°©ì—” ì´ì œ ${this.bag.length}ê°œì˜ ì•„ì´í…œë§Œ ë‚¨ì•˜ë„¤!<br>ìš°ë¦¬ëŠ” 'ë¹„ë°€ì˜ ì œë‹¨'ì— ë„ì°©í–ˆì–´. ğŸ›ï¸`, () => {
              this.addCodiMessage("ì œë‹¨ì—ëŠ” 3ê°œì˜ í™ˆì´ íŒŒì—¬ ìˆê³ , ìˆœì„œëŒ€ë¡œ 'ë¬¼ì˜ ìˆ˜ì •', 'ë¶ˆì˜ ìˆ˜ì •', 'ë°”ëŒì˜ ìˆ˜ì •'ì„ ë¼ì›Œì•¼ ë¬¸ì´ ì—´ë¦°ëŒ€.<br>ìš°ë¦¬ ê°€ë°©ì„ ë³¼ê¹Œ? (í˜„ì¬ ë‚´ê°€ë°©: [" + this.bag.map(item => `'${item}'`).join(", ") + "])", () => {
                this.addCodiMessage("ì´ëŸ°! 'ë¶ˆì˜ ìˆ˜ì •'ì´ ì—†ë„¤! ì €ê¸° ë°˜ì§ì´ëŠ” ê²Œ 'ë¶ˆì˜ ìˆ˜ì •'ì¸ ê²ƒ ê°™ì•„! ì–´ì„œ ì£¼ì›Œì˜¤ì!<br><code>ë‚´ê°€ë°©.append(\'ë¶ˆì˜ ìˆ˜ì •\')</code>ì„ ì…ë ¥í•´ì„œ 'ë¶ˆì˜ ìˆ˜ì •'ì„ ê°€ë°©ì— ë„£ì–´ì¤˜.", () => {
                  messageInput.placeholder = "append ëª…ë ¹ì–´ë¡œ ë¶ˆì˜ ìˆ˜ì •ì„ ì¶”ê°€í•˜ì„¸ìš”...";
                });
              });
            });
            break;

          case 'stage3_altar_check_order':
            this.addCodiMessage("ğŸ”¥ 'ë¶ˆì˜ ìˆ˜ì •'ì„ ê°€ë°©ì— ë„£ì—ˆì–´! (í˜„ì¬ ë‚´ê°€ë°©: [" + this.bag.map(item => `'${item}'`).join(", ") + "])", () => {
              this.addCodiMessage("ê·¸ëŸ°ë° ìˆœì„œê°€ ì•ˆ ë§ë„¤.<br>'ë¬¼ì˜ ìˆ˜ì •' ë‹¤ìŒ, ì¦‰ ë‘ ë²ˆì§¸ì—ëŠ” 'ë¶ˆì˜ ìˆ˜ì •'ì´ ë“¤ì–´ê°€ì•¼ í•˜ëŠ”ë°, ì§€ê¸ˆì€ ë§¨ ë’¤ì— ìˆì–´.<br>íŒŒì´ì¬ì—ì„œ ë¦¬ìŠ¤íŠ¸ì˜ ì¹¸ ë²ˆí˜¸ëŠ” 0ë²ˆë¶€í„° ì‹œì‘í•´. ê·¸ë˜ì„œ 'ë¬¼ì˜ ìˆ˜ì •'ì€ 0ë²ˆ ì¹¸, ê·¸ ë‹¤ìŒì´ 1ë²ˆ ì¹¸, ë§ˆì§€ë§‰ì´ 2ë²ˆ ì¹¸ì´ì•¼.", () => {
                this.addCodiMessage("ë¨¼ì € ë§¨ ë’¤ì— ìˆëŠ” 'ë¶ˆì˜ ìˆ˜ì •'ì„ <code>ë‚´ê°€ë°©.pop(2)</code>ë¡œ ë¹¼ë³¼ê¹Œ? (ê°€ì¥ ë’¤ì— ìˆìœ¼ë‹ˆ 2ë²ˆ ì¹¸ì´ì•¼)<br>ê·¸ ë‹¤ìŒì— <code>ë‚´ê°€ë°©.insert(1, 'ë¶ˆì˜ ìˆ˜ì •')</code>ìœ¼ë¡œ 1ë²ˆ ì¹¸ì— ë„£ì–´ì£¼ë©´ ì™„ë²½í•´!", () => {
                   this.addCodiMessage("ì, ë¨¼ì € <code>ë‚´ê°€ë°©.pop(2)</code>ë¥¼ ì…ë ¥í•´ì„œ 'ë¶ˆì˜ ìˆ˜ì •'ì„ ì ì‹œ êº¼ë‚´ë³´ì!", () => {
                     messageInput.placeholder = "pop ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”...";
                   });
                });
              });
            });
            break;
            
          case 'stage3_altar_after_pop':
            this.addCodiMessage("ì¢‹ì•„! 'ë¶ˆì˜ ìˆ˜ì •'ì„ ê°€ë°©ì—ì„œ ì ì‹œ êº¼ëƒˆì–´. (í˜„ì¬ ë‚´ê°€ë°©: [" + this.bag.map(item => `'${item}'`).join(", ") + "])", () => {
                this.addCodiMessage("ì´ì œ íŠ¹ë³„í•œ ë¼ì›Œë„£ê¸° ë§ˆë²•ì„ ë°°ì›Œë³´ì! ğŸª„<br>ë§ˆì¹˜ ì¹œêµ¬ë“¤ ì‚¬ì´ì— ë¼ì–´ë“¤ ë“¯ì´, ì•„ì´í…œì„ ì›í•˜ëŠ” ìë¦¬ì— ì™ ë„£ì„ ìˆ˜ ìˆì–´!<br><br>ì§€ê¸ˆ ê°€ë°©ì—” [0ë²ˆ: ë¬¼ì˜ ìˆ˜ì •, 1ë²ˆ: ë°”ëŒì˜ ìˆ˜ì •]ì´ ìˆì§€?<br>'ë¶ˆì˜ ìˆ˜ì •'ì„ 1ë²ˆ ìë¦¬ì— ë„£ìœ¼ë©´, 'ë°”ëŒì˜ ìˆ˜ì •'ì€ ë’¤ë¡œ ë°€ë ¤ë‚˜ê²Œ ë¼!<br><br>ëª…ë ¹ì–´: <code>ë‚´ê°€ë°©.insert(1, 'ë¶ˆì˜ ìˆ˜ì •')</code><br>ì´ë ‡ê²Œ í•˜ë©´ â†’ [0ë²ˆ: ë¬¼ì˜ ìˆ˜ì •, 1ë²ˆ: ë¶ˆì˜ ìˆ˜ì •, 2ë²ˆ: ë°”ëŒì˜ ìˆ˜ì •]", () => {
                    messageInput.placeholder = "insert ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”...";
                });
            });
            break;

          case 'stage3_altar_success':
            updateLocation('altar_gate_open', 70); 
            this.addCodiMessage("ì™„ë²½í•´! ğŸ’ ìˆœì„œê°€ ë”± ë§ì•˜ì–´! (í˜„ì¬ ë‚´ê°€ë°©: [" + this.bag.map(item => `'${item}'`).join(", ") + "])<br>ë¹„ë°€ì˜ ë¬¸ì´ ìŠ¤ë¥´ë¥µ ì—´ë¦°ë‹¤!", () => {
              this.addCodiMessage("ì´ <code>insert</code> ë§ˆë²•ì€ ë¡œë¸”ë¡ìŠ¤ì—ì„œ ì•„ì´í…œ ëª©ë¡ì˜ ìˆœì„œë¥¼ ë°”ê¾¸ê±°ë‚˜, ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì¤‘ê°„ì— ë¼ì›Œë„£ì„ ë•Œ ì •ë§ ìœ ìš©í•´!", () => {
                  this.goToStage('stage4_monster_intro');
              });
            });
            break;

          case 'stage4_monster_intro':
            updateLocation('monster_lair', 75); 
            this.addCodiMessage("ë¬¸ ë„ˆë¨¸ì—ëŠ” ë³´ë¬¼ ì°½ê³ ê°€ ìˆì§€ë§Œ... ğŸ‘¾ ì´ëŸ°! ê¸¸ì„ ë§‰ê³  ìˆëŠ” ëª¬ìŠ¤í„°ê°€ ë‚˜íƒ€ë‚¬ì–´!<br>ë‹¤í–‰íˆ ë‚˜ìœ ëª¬ìŠ¤í„°ëŠ” ì•„ë‹Œ ê²ƒ ê°™ì•„.", () => {
              this.addCodiMessage("ëª¬ìŠ¤í„°ê°€ ë§í•˜ê¸¸, 'ë„¤ ê°€ë°©ì˜ ì²« ë²ˆì§¸ ì•„ì´í…œì„ ë‚˜ì—ê²Œ ì„ ë¬¼ë¡œ ì£¼ë©´ ê¸¸ì„ ë¹„ì¼œì£¼ê² ë‹¤!' ë¼ê³  í•˜ë„¤.<br>ì²« ë²ˆì§¸ ì•„ì´í…œì€ 0ë²ˆ ì¹¸ì— ìˆëŠ” ì•„ì´í…œì´ì•¼.", () => {
                this.addCodiMessage("ì´ë²ˆì—” <code>pop</code>ì´ë¼ëŠ” ë§ˆë²•ì„ ì¨ë³´ì!<br><code>êº¼ë‚¸ì•„ì´í…œ = ë‚´ê°€ë°©.pop(ìœ„ì¹˜ë²ˆí˜¸)</code> ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ìœ„ì¹˜ì˜ ì•„ì´í…œì„ êº¼ë‚´ë©´ì„œ, ê·¸ ì•„ì´í…œì„ 'êº¼ë‚¸ì•„ì´í…œ'ì´ë¼ëŠ” ê³³ì— ì ì‹œ ë³´ê´€í•  ìˆ˜ ìˆì–´. ê°€ë°©ì—ì„œëŠ” ê·¸ ì•„ì´í…œì´ ì‚¬ë¼ì§€ê³ !", () => {
                  this.addCodiMessage("ì, <code>ì„ ë¬¼ = ë‚´ê°€ë°©.pop(0)</code> ë˜ëŠ” ê°„ë‹¨íˆ <code>ë‚´ê°€ë°©.pop(0)</code>ì„ ì…ë ¥í•´ì„œ ì²« ë²ˆì§¸ ì•„ì´í…œì„ êº¼ë‚´ ëª¬ìŠ¤í„°ì—ê²Œ ì¤„ ì¤€ë¹„ë¥¼ í•˜ì!", () => {
                    messageInput.placeholder = "pop ëª…ë ¹ì–´ë¡œ ì²« ë²ˆì§¸ ì•„ì´í…œì„ êº¼ë‚´ì„¸ìš”...";
                  });
                });
              });
            });
            break;

          case 'stage4_monster_gift':
            if (this.lastPoppedItem) {
                const giftEmoji = itemEmojis[this.lastPoppedItem] || 'â“';
                this.addCodiMessage(`ì¢‹ì•„! ${giftEmoji} '${this.lastPoppedItem}'(ì„)ë¥¼ êº¼ëƒˆì–´. ì´ì œ ì´ ì„ ë¬¼ì„ ëª¬ìŠ¤í„°ì—ê²Œ ê±´ë„¤ì£¼ì!`, () => {
                    this.addCodiMessage("ëª¬ìŠ¤í„°ê°€ ì„ ë¬¼ì„ ë°›ê³ ëŠ” ì•„ì£¼ ê¸°ë»í•˜ë©° ê¸¸ì„ ë¹„ì¼œì¤¬ì–´! ğŸ¥³<br><code>pop</code> ë§ˆë²• ë•ë¶„ì´ì•¼! ì´ ë§ˆë²•ì€ ê²Œì„ì—ì„œ ì•„ì´í…œì„ ì‚¬ìš©í•˜ë©´ ì¸ë²¤í† ë¦¬ì—ì„œ ì‚¬ë¼ì§€ê²Œ í•  ë•Œ ì“¸ ìˆ˜ ìˆê² ì§€?", () => {
                        this.goToStage('ending_treasure');
                    });
                });
            } else {
                this.addCodiMessage("ì–´ë¼? ëª¬ìŠ¤í„°ì—ê²Œ ì¤„ ì•„ì´í…œì´ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²ƒ ê°™ì•„. ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°€ì„œ ë‹¤ì‹œ í•´ë³¼ê¹Œ?", () => {
                    this.goToStage('stage4_monster_intro'); 
                });
            }
            updateLocation('monster_cleared', 90); 
            break;
            
          case 'ending_treasure':
            updateLocation('treasure_room', 100); 
            this.addCodiMessage(`ë“œë””ì–´ ì „ì„¤ì˜ ë³´ë¬¼ì„ ì°¾ì•˜ì–´, ${this.playerName || 'ì˜ˆë¦°'} íƒí—˜ê°€! ğŸ†âœ¨ ì •ë§ ëŒ€ë‹¨í•´!`, () => {
              this.addCodiMessage("ë„ˆëŠ” ì´ì œ íŒŒì´ì¬ ë¦¬ìŠ¤íŠ¸ ë§ˆë²•ì„ ììœ ìì¬ë¡œ ì‚¬ìš©í•˜ëŠ” ë©‹ì§„ ëª¨í—˜ê°€ê°€ ë˜ì—ˆì–´!", () => {
                this.addCodiMessage("<code>append</code>ë¡œ ì•„ì´í…œ ì¶”ê°€í•˜ê¸°, <code>remove</code>ë¡œ ì•„ì´í…œ ì—†ì• ê¸°, <code>len</code>ìœ¼ë¡œ ê°œìˆ˜ í™•ì¸í•˜ê¸°, <code>insert</code>ë¡œ ì›í•˜ëŠ” ê³³ì— ë¼ì›Œë„£ê¸°, <code>pop</code>ìœ¼ë¡œ íŠ¹ì • ì•„ì´í…œ êº¼ë‚´ê¸°ê¹Œì§€! ëª¨ë‘ ì™„ë²½í•˜ê²Œ ìµí˜”ëŠ”ê±¸!", () => {
                  this.addCodiMessage("ì´ ëª¨ë“  ê±´ ë¡œë¸”ë¡ìŠ¤ ê²Œì„ì„ ë§Œë“¤ ë•Œ ìºë¦­í„°ì˜ ëŠ¥ë ¥ì¹˜, ì¹œêµ¬ ëª©ë¡, ì¸ë²¤í† ë¦¬ ì•„ì´í…œë“¤ì„ ê´€ë¦¬í•˜ëŠ” ë° ì•„ì£¼ ìœ ìš©í•˜ê²Œ ì“°ì¼ ìˆ˜ ìˆëŠ” ê¸°ìˆ ë“¤ì´ì•¼.<br>ì•ìœ¼ë¡œ ë„¤ê°€ ë§Œë“¤ ë©‹ì§„ ê²Œì„ë“¤ì´ ê¸°ëŒ€ë˜ëŠ”ê±¸! ğŸ˜‰", () => {
                    this.addOptions(
                      ['ë‹¤ì‹œ ëª¨í—˜í•˜ê¸° ğŸ”„', 'ë‹¤ë¥¸ ë§ˆë²• ë°°ìš°ëŸ¬ ê°€ê¸° (ì¤€ë¹„ì¤‘) ğŸš§'],
                      'ë‹¤ì‹œ ëª¨í—˜í•˜ê¸° ğŸ”„', 
                      (selectedOption) => { 
                        if (selectedOption === 'ë‹¤ì‹œ ëª¨í—˜í•˜ê¸° ğŸ”„') {
                          this.goToStage('restart');
                        } else {
                          this.goToStage('codi_farewell_soon');
                        }
                      }
                    );
                    messageInput.disabled = true; 
                    sendBtn.disabled = true;
                  });
                });
              });
            });
            break;

          case 'codi_farewell_soon':
            this.addCodiMessage("ì¢‹ì•„! ë‹¤ìŒ ëª¨í—˜ë„ ê³§ ì¤€ë¹„ë  ê±°ì•¼. ê·¸ë•Œ ë‹¤ì‹œ ë§Œë‚˜ì! ğŸ‘‹");
            messageInput.disabled = true;
            messageInput.placeholder = 'ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”!';
            sendBtn.disabled = true;
            break;
            
          case 'restart':
            this.reset();
            break;
        }
      },
      
      reset: function() {
        this.playerName = ''; 
        this.bag = [];
        this.lastPoppedItem = null;
        
        chatContainer.innerHTML = ''; 
        messageInput.disabled = false;
        messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
        sendBtn.disabled = false;
        
        this.updateBackpack();
        this.goToStage('intro'); 
      },
      
      handleInput: function(input) {
        if (!input.trim()) return;
        
        this.addPlayerMessage(input); 
        messageInput.value = ''; 

        const currentStage = this.currentStage; 

        if (currentStage === 'intro') {
          this.playerName = input;
          this.goToStage('intro_confirm_start');
        } else if (currentStage === 'stage1_forest_intro') {
          this.handleCustomInput(input, "ë‚´ê°€ë°©.append('ë“±ë¶ˆ')", 'stage1_forest_append_berry', "ì•—! 'ë“±ë¶ˆ'ì„ ì¶”ê°€í•˜ëŠ” ì •í™•í•œ ëª…ë ¹ì–´ëŠ” <code>ë‚´ê°€ë°©.append(\'ë“±ë¶ˆ\')</code>ì´ì•¼. ë”°ì˜´í‘œì™€ ê´„í˜¸ë¥¼ ì˜ í™•ì¸í•´ë´! ğŸ˜‰");
        } else if (currentStage === 'stage1_forest_append_berry') {
          this.handleCustomInput(input, "ë‚´ê°€ë°©.append('ì—´ë§¤')", 'stage1_forest_len', "ì¢‹ì•„, 'ì—´ë§¤'ë¥¼ ì¶”ê°€í•˜ëŠ” ì£¼ë¬¸ì€ <code>ë‚´ê°€ë°©.append(\'ì—´ë§¤\')</code>ì•¼. ê±°ì˜ ë‹¤ ì™”ì–´!");
        } else if (currentStage === 'stage1_forest_len') {
          this.handleCustomInput(input, "len(ë‚´ê°€ë°©)", () => { 
            this.goToStage('stage2_cave_intro');
          }, "<code>len(ë‚´ê°€ë°©)</code>ì´ ì •í™•í•œ ì£¼ë¬¸ì´ì•¼! ê´„í˜¸ ì•ˆì— 'ë‚´ê°€ë°©'ì„ ë„£ëŠ” ê²ƒ ìŠì§€ ì•Šì•˜ì§€?");
        } else if (currentStage === 'stage2_cave_intro') {
          this.handleCustomInput(input, "ë‚´ê°€ë°©.remove('ë“±ë¶ˆ')", 'stage2_cave_after_remove', "'ë“±ë¶ˆ'ì„ ì—†ì• ë ¤ë©´ <code>ë‚´ê°€ë°©.remove(\'ë“±ë¶ˆ\')</code>ì´ë¼ê³  ì™¸ì³ì•¼ í•´. ê°€ë°©ì— í•´ë‹¹ ì•„ì´í…œì´ ìˆëŠ”ì§€ë„ í™•ì¸í•´ë´! ğŸ’");
        } else if (currentStage === 'stage2_cave_after_remove') {
           this.handleCustomInput(input, "len(ë‚´ê°€ë°©)", () => {
            this.goToStage('stage3_altar_intro');
          }, "ê°€ë°© ì•ˆì˜ ì•„ì´í…œ ê°œìˆ˜ëŠ” <code>len(ë‚´ê°€ë°©)</code>ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´!");
        } else if (currentStage === 'stage3_altar_intro') {
            this.handleCustomInput(input, "ë‚´ê°€ë°©.append('ë¶ˆì˜ ìˆ˜ì •')", 'stage3_altar_check_order', "<code>ë‚´ê°€ë°©.append(\'ë¶ˆì˜ ìˆ˜ì •\')</code>ì„ ì…ë ¥í•´ì„œ ë¶ˆì˜ ìˆ˜ì •ì„ ê°€ë°©ì— ë„£ì–´ì¤˜!");
        } else if (currentStage === 'stage3_altar_check_order') {
            this.handleCustomInput(input, "ë‚´ê°€ë°©.pop(2)", 'stage3_altar_after_pop', "'ë¶ˆì˜ ìˆ˜ì •'ì„ ì œê±°í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì¤˜! <code>ë‚´ê°€ë°©.pop(2)</code>ë¥¼ ì‚¬ìš©í•´ì•¼ í•´.");
        } else if (currentStage === 'stage3_altar_after_pop') {
            this.handleCustomInput(input, "ë‚´ê°€ë°©.insert(1, 'ë¶ˆì˜ ìˆ˜ì •')", 'stage3_altar_success', "<code>ë‚´ê°€ë°©.insert(1, \'ë¶ˆì˜ ìˆ˜ì •\')</code>ì´ ì •í™•í•œ ì£¼ë¬¸ì´ì•¼! ìœ„ì¹˜ ìˆ«ì 1ê³¼ 'ë¶ˆì˜ ìˆ˜ì •'ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ê³ , ì•„ì´í…œ ì´ë¦„ì—” ë”°ì˜´í‘œ! ğŸ˜‰");
        } else if (currentStage === 'stage4_monster_intro') {
            this.handleCustomInput(input, (cmd) => { 
                const popRegex = /^(?:(\w+)\s*=\s*)?ë‚´ê°€ë°©\.pop\(\s*0\s*\)$/;
                if (popRegex.test(cmd)) { 
                    if (this.bag.length > 0 && this.bag[0]) { 
                        return { success: true };
                    } else {
                        return { success: false, message: "âš ï¸ ê°€ë°©ì´ ë¹„ì–´ìˆê±°ë‚˜ ì²« ë²ˆì§¸ ì•„ì´í…œì´ ì—†ì–´! ëª¬ìŠ¤í„°ì—ê²Œ ì¤„ ê²Œ ì—†ë„¤..." };
                    }
                }
                return { success: false, message: "ëª¬ìŠ¤í„°ì—ê²Œ ì²« ë²ˆì§¸ ì•„ì´í…œì„ ì£¼ë ¤ë©´ <code>ë‚´ê°€ë°©.pop(0)</code> ë˜ëŠ” <code>ì„ ë¬¼ = ë‚´ê°€ë°©.pop(0)</code>ì„ ì…ë ¥í•´ì•¼ í•´. 0ë²ˆ ì¹¸ì„ ì •í™•íˆ ì§€ì •í–ˆëŠ”ì§€ í™•ì¸í•´ë´! ğŸ¤“" };
            }, 'stage4_monster_gift');
        }
      }
    };

    const locations = {
      start: { 
        bg: 'linear-gradient(to bottom, #a0c4ff 0%, #c1d8ff 100%)', 
        title: 'ğŸ’ ë³´ë¬¼ì°¾ê¸° ëª¨í—˜ ì‹œì‘!',
        character: 'ğŸ—ºï¸' 
      },
      adventure_start: { 
        bg: 'linear-gradient(to bottom, #b3e0ff 0%, #d1eeff 100%)', 
        title: 'âœ¨ ìƒˆë¡œìš´ ëª¨í—˜ ì¤€ë¹„!',
        character: 'ğŸ§‘â€ğŸš€' 
      },
      forest: {
        bg: 'linear-gradient(to bottom, #90ee90 0%, #c3f3c3 100%)', 
        title: 'ğŸŒ² ì†ì‚­ì´ëŠ” ìˆ²',
        character: 'ğŸ¦‹' 
      },
      cave_bridge: {
        bg: 'linear-gradient(to bottom, #bcaaa4 0%, #d7ccc8 100%)', 
        title: 'ğŸŒ‰ í”ë“¤ë¦¬ëŠ” ë™êµ´ ë‹¤ë¦¬',
        character: 'ğŸ˜¨' 
      },
      altar: {
        bg: 'linear-gradient(to bottom, #fff59d 0%, #fff9c4 100%)', 
        title: 'ğŸ›ï¸ ë¹„ë°€ì˜ ì œë‹¨',
        character: 'ğŸ’' 
      },
      altar_gate_open: { 
        bg: 'linear-gradient(to bottom, #ffe082 0%, #fff1b8 100%)',
        title: 'ğŸŒŸ ë¬¸ì´ ì—´ë ¸ë‹¤!',
        character: 'âœ¨'
      },
      monster_lair: {
        bg: 'linear-gradient(to bottom, #ffab91 0%, #ffccbc 100%)', 
        title: 'ğŸ‘¾ ëª¬ìŠ¤í„°ì˜ ì‹œí—˜',
        character: 'ğŸ‘¹' 
      },
      monster_cleared: { 
        bg: 'linear-gradient(to bottom, #c5e1a5 0%, #e6ee9c 100%)',
        title: 'ğŸ˜… íœ´, ì§€ë‚˜ê°”ë‹¤!',
        character: 'ğŸ¥³'
      },
      treasure_room: { 
        bg: 'linear-gradient(to bottom, #ffd700 0%, #fffacd 100%)', 
        title: 'ğŸ† ì „ì„¤ì˜ ë³´ë¬¼ ë°œê²¬!',
        character: 'ğŸ‰'
      }
    };

    const itemEmojis = {
      'ë“±ë¶ˆ': 'ğŸ’¡',
      'ì—´ë§¤': 'ğŸ“',
      'ë¬¼ì˜ ìˆ˜ì •': 'ğŸ’§',
      'ë¶ˆì˜ ìˆ˜ì •': 'ğŸ”¥',
      'ë°”ëŒì˜ ìˆ˜ì •': 'ğŸŒ¬ï¸',
      'ë¬¼ë³‘': 'ğŸ¼', 
      'ì§€ë„': 'ğŸ—ºï¸',
      'ì†ì „ë“±': 'ğŸ”¦',
      'ìˆ˜ì˜ë³µ': 'ğŸ©±',
      'ë¬¼': 'ğŸ’¦',
      'ëª¨ì': 'ğŸ‘’',
      'ì„ í¬ë¦¼': 'ğŸ§´',
      'ë¡œí”„': 'ğŸ§µ'
    };

    function updateLocation(locationKey, progress) {
      const location = locations[locationKey];
      if (location) { 
        locationBg.style.background = location.bg;
        locationTitle.textContent = location.title;
        locationCharacter.textContent = location.character;
        progressBar.style.width = `${progress}%`;
      } else {
        console.warn(`Location key "${locationKey}" not found in locations object.`);
        locationBg.style.background = 'linear-gradient(to bottom, #cccccc 0%, #999999 100%)';
        locationTitle.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ';
        locationCharacter.textContent = 'â“';
      }
    }

    function scrollToBottom() {
      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 10); 
    }

    function toggleBackpack() {
      backpackContainer.classList.toggle('show');
      if (backpackContainer.classList.contains('show')) {
        game.updateBackpack();
      }
    }

    sendBtn.addEventListener('click', () => {
      if (!messageInput.disabled && messageInput.value.trim()) {
        const input = messageInput.value.trim();
        game.handleInput(input);
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !messageInput.disabled && messageInput.value.trim()) {
        const input = messageInput.value.trim();
        game.handleInput(input);
      }
    });

    backpackBtn.addEventListener('click', toggleBackpack);

    game.goToStage('intro');
  </script>
</body>
</html>
