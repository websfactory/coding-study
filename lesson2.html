<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>íŒŒì´ì¬ íƒí—˜ëŒ€ì˜ ì‹ ë¹„í•œ ì—¬í–‰ ğŸš€</title>
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }

    body {
      background-color: #f5f7fa;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      overflow: hidden;
      height: 100%;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      position: relative;
    }
    
    html {
      height: 100%;
      min-height: 100dvh;
      min-height: -webkit-fill-available;
    }

    /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì„¤ì • */
    :root {
      height: 100dvh;
      height: -webkit-fill-available;
    }
    
    /* CSS ë³€ìˆ˜ë¡œ ë·°í¬íŠ¸ ë†’ì´ ê´€ë¦¬ */
    :root {
      --vh: 1vh;
    }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .container {
      display: flex;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100);
      min-height: 100dvh;
      min-height: -webkit-fill-available;
      overflow: hidden;
      position: relative;
    }

    /* ìœ„ì¹˜ ë°°ê²½ */
    .location-bg {
      width: 100%;
      height: 180px;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      position: relative;
      transition: all 1s ease;
      border-bottom: 5px solid #64B5F6;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* ìºë¦­í„° ìŠ¤íƒ€ì¼ */
    .character {
      font-size: 4rem;
      animation: bounce 2s infinite;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      z-index: 5;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* ìœ„ì¹˜ íƒ€ì´í‹€ */
    .location-title {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ì±„íŒ… ì˜ì—­ */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 85px; /* ì…ë ¥ì°½ ë†’ì´ + ì—¬ìœ  ê³µê°„ */
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 4px;
      position: relative;
      word-break: break-word;
      animation: fadeIn 0.3s forwards;
    }

    /* ë©”ì‹œì§€ í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ì½”ë”” ë©”ì‹œì§€ */
    .codi-message {
      align-self: flex-start;
      background-color: #E3F2FD;
      border-bottom-left-radius: 5px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* í”Œë ˆì´ì–´ ë©”ì‹œì§€ */
    .player-message {
      align-self: flex-end;
      background-color: #E8F5E9;
      border-bottom-right-radius: 5px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ */
    .sender-name {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    /* ì…ë ¥ ì˜ì—­ */
    .input-container {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
      background-color: white;
      border-top: 1px solid #e1e4e8;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      /* ë¸Œë¼ìš°ì € ë°” ë†’ì´ ê³ ë ¤ */
      bottom: calc(0px + (100vh - 100%));
      /* êµ¬ë²„ì „ iOS ì§€ì› */
      padding-bottom: calc(12px + constant(safe-area-inset-bottom, 45px));
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
    }

    /* ì…ë ¥ì°½ */
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e1e4e8;
      border-radius: 24px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
    }

    .message-input:focus {
      border-color: #64B5F6;
    }

    .message-input:disabled {
      background-color: #f5f7fa;
      cursor: not-allowed;
    }

    /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .btn {
      border: none;
      background-color: #2196F3;
      color: white;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      transition: background-color 0.3s, transform 0.2s;
      outline: none;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ì œì¶œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
    @media (max-width: 768px) {
      #sendBtn {
        display: none;
      }
    }

    .btn:hover {
      background-color: #1976D2;
      transform: scale(1.05);
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn:disabled {
      background-color: #B0BEC5;
      cursor: not-allowed;
      transform: none;
    }

    /* ë°±íŒ© ë²„íŠ¼ */
    .backpack-btn {
      background-color: #4CAF50;
    }

    .backpack-btn:hover {
      background-color: #388E3C;
    }

    /* ì„ íƒì§€ ìŠ¤íƒ€ì¼ */
    .options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    .option-btn {
      background-color: #E8EAF6;
      color: #3F51B5;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      text-align: left;
      transition: background-color 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      font-weight: 500;
    }

    .option-btn:hover {
      background-color: #C5CAE9;
      transform: translateX(5px);
    }

    .option-btn:active {
      transform: translateX(2px);
    }

    /* ë°±íŒ© ì˜ì—­ */
    .backpack-container {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom, 20px));
      right: 15px;
      background-color: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 10;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .backpack-container.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    .backpack-title {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #333;
    }

    .backpack-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .item {
      background-color: #FFF9C4;
      color: #F57F17;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 0.9rem;
      animation: popIn 0.4s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @keyframes popIn {
      0% { transform: scale(0); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .empty-bag {
      color: #9E9E9E;
      font-style: italic;
    }

    /* íŒíŠ¸ ìŠ¤íƒ€ì¼ */
    .hint {
      background-color: #FFF8E1;
      border-left: 4px solid #FFC107;
      padding: 12px 16px;
      margin-top: 6px;
      margin-bottom: 10px;
      border-radius: 4px;
      animation: fadeIn 0.5s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ì˜¤ë¥˜ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .error-message {
      color: #D32F2F;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      background-color: #FFEBEE;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    /* ì„±ê³µ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .success-message {
      color: #388E3C;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      background-color: #E8F5E9;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: popIn 0.5s;
    }

    /* ë¡œë”© íš¨ê³¼ */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background-color: #E3F2FD;
      border-radius: 18px;
      width: fit-content;
      margin-bottom: 6px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #64B5F6;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* ì •ë‹µ ì…ë ¥ ìŠ¤íƒ€ì¼ */
    .correct-answer {
      color: #388E3C;
      font-weight: bold;
    }

    /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .progress-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.3);
    }

    .progress-bar {
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.5s ease;
    }
    
    /* Safari ë²„ê·¸ í•´ê²°ì„ ìœ„í•œ ë¹ˆ ê³ ì • ìš”ì†Œ */
    .safari-fix {
      position: fixed;
      top: 0;
      left: 0;
      width: 1px;
      height: 1px;
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .input-container {
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 45px));
        bottom: env(safe-area-inset-bottom, 0);
      }
    }
    
    /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì§€ì› ë¸Œë¼ìš°ì € */
    @supports (height: 100dvh) {
      .container {
        min-height: 100dvh;
        height: 100dvh;
      }
    }
    
    /* ì‘ì€ í™”ë©´ì—ì„œ ë°±íŒ© ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
    @media (max-height: 600px) {
      .backpack-container {
        bottom: calc(120px + env(safe-area-inset-bottom, 45px));
      }
      
      .chat-container {
        padding-bottom: 105px;
      }
    }
    
    /* iOS í‚¤ë³´ë“œ ëŒ€ì‘ */
    @supports (-webkit-touch-callout: none) {
      .input-container {
        position: fixed;
        bottom: 0;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform;
      }
    }
  </style>
</head>
<body>
  <!-- Safari ë²„ê·¸ í•´ê²°ì„ ìœ„í•œ ë¹ˆ ê³ ì • ìš”ì†Œ -->
  <div class="safari-fix"></div>
  
  <div class="container">
    <!-- ìœ„ì¹˜ ë°°ê²½ ì˜ì—­ -->
    <div class="location-bg" id="locationBg">
      <div class="character" id="locationCharacter">ğŸ¤–</div>
      <div class="location-title" id="locationTitle">ğŸ‘‹ íŒŒì´ì¬ íƒí—˜ëŒ€ì˜ ì‹ ë¹„í•œ ì—¬í–‰</div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <div class="chat-container" id="chatContainer" role="log" aria-live="polite"></div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-container">
      <input type="text" class="message-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button class="btn" id="sendBtn" aria-label="ì „ì†¡">ğŸ“¤</button>
      <button class="btn backpack-btn" id="backpackBtn" aria-label="ë‚´ê°€ë°© ë³´ê¸°">ğŸ’</button>
    </div>
  </div>

  <!-- ë°±íŒ© ì»¨í…Œì´ë„ˆ -->
  <div class="backpack-container" id="backpackContainer">
    <div class="backpack-title">ğŸ’ ë‚´ê°€ë°©</div>
    <div class="backpack-items" id="backpackItems">
      <div class="empty-bag">ê°€ë°©ì´ ë¹„ì–´ìˆì–´ìš”</div>
    </div>
  </div>

  <script>
    // ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì„¤ì • - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë°” ëŒ€ì‘
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    // ì´ˆê¸° ì„¤ì • ë° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', setViewportHeight);
    
    // Visual Viewport API ì‚¬ìš© (ì§€ì›í•˜ëŠ” ê²½ìš°)
    if ('visualViewport' in window) {
      window.visualViewport.addEventListener('resize', () => {
        const height = window.visualViewport.height;
        const bottomOffset = window.innerHeight - height;
        const inputContainer = document.querySelector('.input-container');
        if (inputContainer) {
          inputContainer.style.bottom = `${bottomOffset}px`;
        }
      });
    }
    
    // DOM ìš”ì†Œ
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const backpackBtn = document.getElementById('backpackBtn');
    const backpackContainer = document.getElementById('backpackContainer');
    const backpackItems = document.getElementById('backpackItems');
    const locationBg = document.getElementById('locationBg');
    const locationTitle = document.getElementById('locationTitle');
    const locationCharacter = document.getElementById('locationCharacter');
    const progressBar = document.getElementById('progressBar');

    // ê²Œì„ ìƒíƒœ ê°ì²´
    const game = {
      playerName: '',
      currentStage: 'intro',
      bag: [],
      poppedItem: '',
      isTyping: false,
      
      // ë°±íŒ© ì—…ë°ì´íŠ¸
      updateBackpack: function() {
        if (this.bag.length === 0) {
          backpackItems.innerHTML = '<div class="empty-bag">ê°€ë°©ì´ ë¹„ì–´ìˆì–´ìš”</div>';
          return;
        }

        backpackItems.innerHTML = '';
        this.bag.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'item';
          const emoji = itemEmojis[item] || 'ğŸ”®';
          itemElement.textContent = `${emoji} ${item}`;
          backpackItems.appendChild(itemElement);
        });
      },
      
      // ì½”ë”” ë©”ì‹œì§€ ì¶”ê°€
      addCodiMessage: function(text, callback) {
        // ì´ë¯¸ íƒ€ì´í•‘ ì¤‘ì´ë©´ ë¬´ì‹œ
        if (this.isTyping) return;
        
        this.isTyping = true;
        
        // íƒ€ì´í•‘ í‘œì‹œê¸° ì¶”ê°€
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        `;
        chatContainer.appendChild(typingIndicator);
        scrollToBottom();
        
        // íƒ€ì´í•‘ íš¨ê³¼ ì‹œì‘ ì „ ì ì‹œ ëŒ€ê¸°
        setTimeout(() => {
          // íƒ€ì´í•‘ í‘œì‹œê¸° ì œê±°
          chatContainer.removeChild(typingIndicator);
          
          // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
          const messageElement = document.createElement('div');
          messageElement.className = 'message codi-message';
          
          const senderElement = document.createElement('div');
          senderElement.className = 'sender-name';
          senderElement.textContent = 'ì½”ë”” ğŸ¤–';
          
          const textElement = document.createElement('div');
          textElement.textContent = '';
          
          messageElement.appendChild(senderElement);
          messageElement.appendChild(textElement);
          chatContainer.appendChild(messageElement);
          
          // íƒ€ì´í•‘ íš¨ê³¼
          let i = 0;
          const typingSpeed = 20;
          
          const typeChar = () => {
            if (i < text.length) {
              textElement.textContent += text.charAt(i);
              i++;
              scrollToBottom();
              setTimeout(typeChar, typingSpeed);
            } else {
              // íƒ€ì´í•‘ ì™„ë£Œ
              this.isTyping = false;
              if (callback) {
                setTimeout(callback, 300);
              }
            }
          };
          
          typeChar();
        }, 500);
      },
      
      // í”Œë ˆì´ì–´ ë©”ì‹œì§€ ì¶”ê°€
      addPlayerMessage: function(text) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message player-message';
        
        const senderElement = document.createElement('div');
        senderElement.className = 'sender-name';
        senderElement.textContent = this.playerName || 'íƒí—˜ê°€';
        
        const textElement = document.createElement('div');
        textElement.textContent = text;
        
        messageElement.appendChild(senderElement);
        messageElement.appendChild(textElement);
        chatContainer.appendChild(messageElement);
        
        scrollToBottom();
      },
      
      // ì„ íƒì§€ ë²„íŠ¼ ì¶”ê°€
      addOptions: function(options, correctOption, nextStage) {
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-container';
        
        // ì…ë ¥ì°½ ë¹„í™œì„±í™”
        messageInput.disabled = true;
        messageInput.placeholder = 'ì„ íƒì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”...';
        
        options.forEach(option => {
          const optionBtn = document.createElement('button');
          optionBtn.className = 'option-btn';
          optionBtn.setAttribute('aria-label', option);
          optionBtn.textContent = option;
          
          optionBtn.addEventListener('click', () => {
            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.option-btn').forEach(btn => {
              btn.disabled = true;
              btn.style.opacity = 0.5;
            });
            
            // ì„ íƒí•œ ë²„íŠ¼ ê°•ì¡°
            optionBtn.style.opacity = 1;
            optionBtn.style.backgroundColor = '#C5CAE9';
            
            // ì„ íƒ ë©”ì‹œì§€ í‘œì‹œ
            this.addPlayerMessage(option);
            
            // ì„ íƒì§€ ì»¨í…Œì´ë„ˆ ì œê±°
            setTimeout(() => {
              chatContainer.removeChild(optionsContainer);
              
              // ì…ë ¥ì°½ ë‹¤ì‹œ í™œì„±í™”
              messageInput.disabled = false;
              messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
              
              // ì •ë‹µ ì—¬ë¶€ í™•ì¸
              if (option === correctOption) {
                // ì •ë‹µì¸ ê²½ìš°
                this.showSuccess();
                
                // ëª…ë ¹ì–´ ì‹¤í–‰ (ê°€ë°©ì— ì•„ì´í…œ ì¶”ê°€/ì œê±°)
                this.executeCommand(option);
                
                // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                  this.goToStage(nextStage);
                }, 1000);
              } else {
                // ì˜¤ë‹µì¸ ê²½ìš°
                this.showError();
              }
            }, 500);
          });
          
          optionsContainer.appendChild(optionBtn);
        });
        
        chatContainer.appendChild(optionsContainer);
        scrollToBottom();
      },
      
      // ì»¤ìŠ¤í…€ ì…ë ¥ ì²˜ë¦¬ (ì§ì ‘ ì…ë ¥í•˜ëŠ” ë‹¨ê³„ìš©)
      handleCustomInput: function(input, correctAnswer, nextStage) {
        if (input === correctAnswer ||
            (correctAnswer === 'ë‚´ê°€ë°©.remove' && input.startsWith('ë‚´ê°€ë°©.remove')) ||
            (correctAnswer === 'ë‚´ê°€ë°©.insert' && input.startsWith('ë‚´ê°€ë°©.insert')) ||
            (correctAnswer === 'ë‚´ê°€ë°©.pop' && input.startsWith('ë‚´ê°€ë°©.pop'))) {
          // ì •ë‹µì¸ ê²½ìš°
          this.showSuccess();
          
          // ëª…ë ¹ì–´ ì‹¤í–‰
          this.executeCommand(input);
          
          // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
          setTimeout(() => {
            this.goToStage(nextStage);
          }, 1000);
        } else {
          // ì˜¤ë‹µì¸ ê²½ìš°
          this.showError();
        }
      },
      
      // ëª…ë ¹ì–´ ì‹¤í–‰ (ê°€ë°© ê´€ë¦¬)
      executeCommand: function(command) {
        if (command.includes('ë‚´ê°€ë°©.append')) {
          // append ëª…ë ¹ ì²˜ë¦¬
          const matches = command.match(/\'(.*?)\'/);
          if (matches && matches[1]) {
            const item = matches[1];
            this.bag.push(item);
            this.updateBackpack();
          } else {
            this.showError('ì•„ì´í…œ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.');
          }
        } else if (command.includes('ë‚´ê°€ë°©.remove')) {
          // remove ëª…ë ¹ ì²˜ë¦¬
          const matches = command.match(/\'(.*?)\'/);
          if (matches && matches[1]) {
            const item = matches[1];
            const index = this.bag.indexOf(item);
            if (index !== -1) {
              this.bag.splice(index, 1);
              this.updateBackpack();
            } else {
              this.showError('í•´ë‹¹ ì•„ì´í…œì´ ê°€ë°©ì— ì—†ìŠµë‹ˆë‹¤');
            }
          } else {
            this.showError('ì•„ì´í…œ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.');
          }
        } else if (command.includes('ë‚´ê°€ë°©.insert')) {
          // insert ëª…ë ¹ ì²˜ë¦¬
          const matches = command.match(/insert\((\d+),\s*'(.*?)'\)/);
          if (matches) {
            const index = parseInt(matches[1], 10);
            const item = matches[2];
            if (index >= 0 && index <= this.bag.length) {
              this.bag.splice(index, 0, item);
              this.updateBackpack();
            } else {
              this.showError('ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ì–´ìš”');
            }
          } else {
            this.showError('insert ëª…ë ¹ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”');
          }
        } else if (command.includes('ë‚´ê°€ë°©.pop')) {
          // pop ëª…ë ¹ ì²˜ë¦¬
          const matches = command.match(/pop\((\d+)\)/);
          if (matches) {
            const index = parseInt(matches[1], 10);
            if (index >= 0 && index < this.bag.length) {
              this.poppedItem = this.bag.splice(index, 1)[0];
              this.updateBackpack();
            } else {
              this.showError('ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ì–´ìš”');
            }
          } else {
            this.showError('pop ëª…ë ¹ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”');
          }
        }
      },
      
      // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      showSuccess: function() {
        const successElement = document.createElement('div');
        successElement.className = 'success-message';
        successElement.innerHTML = 'âœ… ì •í™•í•´ìš”! ì˜í–ˆì–´ìš”!';
        chatContainer.appendChild(successElement);
        scrollToBottom();
      },
      
      // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
      showError: function(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        const msg = message || 'âŒ ì•„ì‰½ê²Œë„ í‹€ë ¸ì–´ìš”! ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”?';
        errorElement.innerHTML = msg;
        chatContainer.appendChild(errorElement);
        scrollToBottom();
        
        // ì¬ì‹œì‘ ë²„íŠ¼ ì¶”ê°€
        setTimeout(() => {
          const restartContainer = document.createElement('div');
          restartContainer.className = 'options-container';
          
          const restartBtn = document.createElement('button');
          restartBtn.className = 'option-btn';
          restartBtn.setAttribute('aria-label', 'ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ê¸°');
          restartBtn.innerHTML = 'ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ê¸°';
          
          restartBtn.addEventListener('click', () => {
            restartContainer.remove();
            this.reset();
          });
          
          restartContainer.appendChild(restartBtn);
          chatContainer.appendChild(restartContainer);
          scrollToBottom();
          
          // ì…ë ¥ì°½ ë¹„í™œì„±í™”
          messageInput.disabled = true;
          messageInput.placeholder = 'ë‹¤ì‹œ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”...';
          sendBtn.disabled = true;
        }, 1000);
      },
      
      // ê²Œì„ ìŠ¤í…Œì´ì§€ ì§„í–‰
      goToStage: function(stageName) {
        this.currentStage = stageName;
        
        // ìŠ¤í…Œì´ì§€ë³„ ì²˜ë¦¬
        switch(stageName) {
          case 'intro':
            updateLocation('start', 0);
            this.addCodiMessage('ì•ˆë…•! ğŸ‘‹ ë‚˜ëŠ” ì½”ë””ì•¼. íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°ì„ ê°€ë¥´ì³ ì¤„ ë¡œë´‡ì´ì•¼. ë„ˆì˜ ì´ë¦„ì€ ë­ë‹ˆ?');
            break;
            
          case 'start':
            updateLocation('start', 0);
            this.addCodiMessage(`${this.playerName}ì•„(ì•¼), ë°˜ê°€ì›Œ! ğŸ¤© ì´ íŠ¹ë³„í•œ ê°€ë°©ì€ 'ë‚´ê°€ë°©'ì´ë¼ê³  ë¶ˆëŸ¬. íŒŒì´ì¬ ëª…ë ¹ì–´ë¡œ ì‘ë™í•˜ëŠ” ë§ˆë²• ê°€ë°©ì´ì•¼!`, () => {
              this.addCodiMessage('ë‚´ê°€ë°© = []', () => {
                this.addCodiMessage('ê°€ë°©ì´ ë¹„ì–´ìˆì–´. ì´ì œ ì‹ ë¹„í•œ ì„¸ê³„ë¡œ ëª¨í—˜ì„ ë– ë‚  ì¤€ë¹„ê°€ ë˜ì—ˆë‹ˆ?', () => {
                  this.addOptions(
                    ['ë„¤, ëª¨í—˜ì„ ì‹œì‘í• ë˜ìš”! ğŸš€'], 
                    'ë„¤, ëª¨í—˜ì„ ì‹œì‘í• ë˜ìš”! ğŸš€',
                    'forest-1'
                  );
                });
              });
            });
            break;
            
          case 'forest-1':
            updateLocation('forest', 20);
            this.addCodiMessage('ìš°ë¦¬ëŠ” ì‹ ë¹„ì˜ ìˆ²ì— ë„ì°©í–ˆì–´! ğŸŒ² ìˆ²ì—ì„œëŠ” ê¸¸ì„ ìƒì§€ ì•Šê²Œ ì—¬ëŸ¬ ë¬¼ê±´ì´ í•„ìš”í•´.', () => {
              this.addCodiMessage('ê°€ë°©ì— ë¬¼ê±´ì„ ë„£ìœ¼ë ¤ë©´ ì–´ë–¤ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?', () => {
                this.addOptions(
                  [
                    'ë‚´ê°€ë°©.append(\'ë¬¼ë³‘\')',
                    'ë‚´ê°€ë°©.add(\'ë¬¼ë³‘\')',
                    'ë‚´ê°€ë°©.put(\'ë¬¼ë³‘\')'
                  ],
                  'ë‚´ê°€ë°©.append(\'ë¬¼ë³‘\')',
                  'forest-2'
                );
              });
            });
            break;
            
          case 'forest-2':
            this.addCodiMessage('ì˜í–ˆì–´! ğŸ’§ ë¬¼ë³‘ì´ ê°€ë°©ì— ë“¤ì–´ê°”ì–´.', () => {
              this.addCodiMessage('ì´ì œ ì§€ë„ë„ í•„ìš”í•  ê²ƒ ê°™ì•„. ì§€ë„ë¥¼ ê°€ë°©ì— ë„£ì–´ë³´ì!', () => {
                this.addOptions(
                  [
                    'ë‚´ê°€ë°©.append(\'ì§€ë„\')',
                    'ë‚´ê°€ë°©.add(\'ì§€ë„\')',
                    'ë‚´ê°€ë°©.put(\'ì§€ë„\')'
                  ],
                  'ë‚´ê°€ë°©.append(\'ì§€ë„\')',
                  'forest-3'
                );
              });
            });
            break;
            
          case 'forest-3':
            this.addCodiMessage('ì¢‹ì•„! ğŸ—ºï¸ ì§€ë„ë„ ë„£ì—ˆì–´. ì´ì œ ì†ì „ë“±ë„ í•„ìš”í•´. ë„£ì–´ë³¼ê¹Œ?', () => {
              this.addOptions(
                [
                  'ë‚´ê°€ë°©.append(\'ì†ì „ë“±\')',
                  'ë‚´ê°€ë°©.appand(\'ì†ì „ë“±\')',
                  'ë‚´ê°€ë°©.apppend(\'ì†ì „ë“±\')'
                ],
                'ë‚´ê°€ë°©.append(\'ì†ì „ë“±\')',
                'forest-wolf'
              );
            });
            break;
            
          case 'forest-wolf':
            this.addCodiMessage('ì•—! ğŸº ëŠ‘ëŒ€ê°€ ë‚˜íƒ€ë‚¬ì–´! ë¹¨ë¦¬ ë„ë§ê°€ì•¼ í•´!', () => {
              this.addCodiMessage('í•˜ì§€ë§Œ ê°€ë°©ì´ ë„ˆë¬´ ë¬´ê±°ì›Œ... ì†ì „ë“±ì„ êº¼ë‚´ì•¼ í•  ê²ƒ ê°™ì•„!', () => {
                this.addCodiMessage('ê°€ë°©ì—ì„œ ë¬¼ê±´ì„ ë¹¼ë ¤ë©´ ì–´ë–¤ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?', () => {
                  this.addOptions(
                    [
                      'ë‚´ê°€ë°©.remove(\'ì†ì „ë“±\')',
                      'ë‚´ê°€ë°©.delete(\'ì†ì „ë“±\')',
                      'ë‚´ê°€ë°©.take(\'ì†ì „ë“±\')'
                    ],
                    'ë‚´ê°€ë°©.remove(\'ì†ì „ë“±\')',
                    'sea-1'
                  );
                });
              });
            });
            break;
            
          case 'sea-1':
            updateLocation('sea', 40);
            this.addCodiMessage('íœ´, ë¬´ì‚¬íˆ ëŠ‘ëŒ€ë¥¼ í”¼í–ˆì–´! ğŸƒâ€â™‚ï¸ ì´ì œ ìš°ë¦¬ëŠ” ì‹ ë¹„ì˜ ë°”ë‹¤ì— ë„ì°©í–ˆì–´.', () => {
              this.addCodiMessage('ë°”ë‹¤ì—ì„œëŠ” ìƒˆë¡œìš´ ë¬¼ê±´ë“¤ì´ í•„ìš”í•´. ë¨¼ì € ê°€ë°©ì— ë¬¼ê±´ì´ ëª‡ ê°œ ìˆëŠ”ì§€ í™•ì¸í•´ë³¼ê¹Œ?', () => {
                this.addOptions(
                  [
                    'ê°œìˆ˜ = len(ë‚´ê°€ë°©)',
                    'ê°œìˆ˜ = count(ë‚´ê°€ë°©)'
                  ],
                  'ê°œìˆ˜ = len(ë‚´ê°€ë°©)',
                  'sea-2'
                );
              });
            });
            break;
            
          case 'sea-2':
            this.addCodiMessage(`ê°€ë°©ì—ëŠ” ${this.bag.length}ê°œì˜ ë¬¼ê±´ì´ ìˆì–´! ğŸ“Š`, () => {
              this.addCodiMessage('ì´ì œ ìˆ˜ì˜ë³µì„ ê°€ë°©ì— ë„£ì–´ë³´ì. ëª…ë ¹ì–´ëŠ” ê¸°ì–µë‚˜ë‹ˆ?', () => {
                this.addCodiMessage('íŒíŠ¸ : ë‚´ê°€ë°©.a??e??(\'ìˆ˜ì˜ë³µ\')');
                // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
                messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
              });
            });
            break;
            
          case 'sea-monster':
            this.addCodiMessage('ìˆ˜ì˜ë³µì„ ë„£ì—ˆì–´! ğŸ©± ì¢‹ì•„, ì´ì œ ë°”ë‹¤ë¥¼ íƒí—˜í•  ì¤€ë¹„ê°€ ëì–´!', () => {
              this.addCodiMessage('ì•—! ğŸ¦‘ ë°”ë‹¤ ê´´ë¬¼ì´ ë‚˜íƒ€ë‚¬ì–´! ê´´ë¬¼ì´ ìš°ë¦¬ì—ê²Œ ë­”ê°€ë¥¼ ì›í•˜ëŠ” ê²ƒ ê°™ì•„...', () => {
                this.addCodiMessage('ê´´ë¬¼ì´ ì§€ë„ë¥¼ ì°¾ê³  ìˆì–´! ì§€ë„ë¥¼ ê´´ë¬¼ì—ê²Œ ì£¼ë ¤ë©´ ê°€ë°©ì—ì„œ ë¹¼ì•¼ í•´!', () => {
                  this.addCodiMessage('íŒíŠ¸: ë‚´ê°€ë°©.rem?ve(\'ì§€ë„\')ë¥¼ ì‚¬ìš©í•´ ì§€ë„ë¥¼ ë¹¼ë³´ì!');
                  // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
                  messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                });
              });
            });
            break;
            
          case 'desert-1':
            updateLocation('desert', 60);
            this.addCodiMessage('ê´´ë¬¼ì—ê²Œ ì§€ë„ë¥¼ ì£¼ê³  ë¬´ì‚¬íˆ ì§€ë‚˜ì™”ì–´! ğŸ‘ ì´ì œ ìš°ë¦¬ëŠ” ì‹ ë¹„ì˜ ì‚¬ë§‰ì— ë„ì°©í–ˆì–´.', () => {
              this.addCodiMessage('ì‚¬ë§‰ì—ì„œëŠ” ë¬¼ì´ ì •ë§ ì¤‘ìš”í•´. ê°€ë°©ì— ë¬¼ì„ ë„£ì–´ë³´ì!', () => {
                this.addCodiMessage('ì´ì œëŠ” íŒíŠ¸ ì—†ì´ ì§ì ‘ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë´. ê°€ë°©ì— ë¬¼ì„ ì¶”ê°€í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì¤˜!');
                // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
                messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
              });
            });
            break;
            
          case 'desert-2':
            this.addCodiMessage('ì˜í–ˆì–´! ğŸ’¦ ë¬¼ì„ ê°€ë°©ì— ë„£ì—ˆì–´. ì‚¬ë§‰ì€ ë‚®ì—ëŠ” ëœ¨ê²ê³  ë°¤ì—ëŠ” ì¶”ì›Œ.', () => {
              this.addCodiMessage('ì´ì œ ëª¨ìë„ í•„ìš”í•  ê²ƒ ê°™ì•„. ëª¨ìë¥¼ ê°€ë°©ì— ì¶”ê°€í•´ë³´ì!');
              // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
              messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
            });
            break;
            
          case 'desert-3':
            this.addCodiMessage('ì¢‹ì•„! ğŸ‘’ ëª¨ìë„ ë„£ì—ˆì–´.', () => {
              this.addCodiMessage('ì´ì œ ì„ í¬ë¦¼ë„ í•„ìš”í•´. ì„ í¬ë¦¼ì„ ê°€ë°©ì— ì¶”ê°€í•´ë³´ì!');
              // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
              messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
            });
            break;
            
          case 'desert-storm':
            this.addCodiMessage('ì•—! ğŸŒªï¸ ëª¨ë˜í­í’ì´ ë‹¤ê°€ì˜¤ê³  ìˆì–´! ê°€ë°©ì´ ë„ˆë¬´ ë¬´ê±°ì›Œì„œ í”¼í•˜ê¸° ì–´ë ¤ì›Œ!', () => {
              this.addCodiMessage('ê°€ë°©ì— ë­ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í•„ìš”ì—†ëŠ” ë¬¼ê±´ì„ ë¹¼ì•¼ í•´!', () => {
                this.addCodiMessage(`í˜„ì¬ ë‚´ê°€ë°©: ${JSON.stringify(this.bag)}`, () => {
                  this.addCodiMessage('ë¬¼ê±´ì„ í•˜ë‚˜ ë¹¼ëŠ” ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë´.');
                  // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
                  messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                });
              });
            });
            break;

          case 'altar-append':
            updateLocation('altar', 70);
            this.addCodiMessage('ëª¨ë˜í­í’ì„ í”¼í•˜ê³  ë¹„ë°€ì˜ ì œë‹¨ì— ë„ì°©í–ˆì–´.', () => {
              this.addCodiMessage('ì €ê¸° ë°˜ì§ì´ëŠ” \'ë¶ˆì˜ ìˆ˜ì •\'ì„ ë°œê²¬í–ˆì–´! ê°€ë°©ì— ë„£ì–´ë³¼ê¹Œ?', () => {
                this.addOptions(
                  [
                    "ë‚´ê°€ë°©.append('ë¶ˆì˜ ìˆ˜ì •')",
                    "ë‚´ê°€ë°©.add('ë¶ˆì˜ ìˆ˜ì •')"
                  ],
                  "ë‚´ê°€ë°©.append('ë¶ˆì˜ ìˆ˜ì •')",
                  'altar-insert'
                );
              });
            });
            break;

          case 'altar-insert':
            this.addCodiMessage('ì¢‹ì•„! ê·¸ëŸ°ë° ë¶ˆì˜ ìˆ˜ì •ì€ ë‘ ë²ˆì§¸ ì¹¸ì— ìˆì–´ì•¼ í•´.', () => {
              this.addCodiMessage('í˜„ì¬ ë‚´ê°€ë°©: ' + JSON.stringify(this.bag), () => {
                this.addCodiMessage("ë¶ˆì˜ ìˆ˜ì •ì„ ë‘ ë²ˆì§¸ ìœ„ì¹˜ì— ë„£ì–´ë³´ì.", () => {
                  messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                });
              });
            });
            break;

          case 'monster-test':
            updateLocation('monster', 75);
            this.addCodiMessage('ì œë‹¨ì„ ì§€ë‚˜ë‹ˆ ëª¬ìŠ¤í„°ê°€ ê¸¸ì„ ë§‰ê³  ìˆì–´!', () => {
              this.addCodiMessage('ëª¬ìŠ¤í„°ê°€ ê°€ë°©ì˜ ì²« ë²ˆì§¸ ì•„ì´í…œì„ ë‹¬ë¼ê³  í•´.', () => {
                this.addCodiMessage('ì²« ë²ˆì§¸ ì•„ì´í…œì„ êº¼ë‚´ ì£¼ë ¤ë©´ ì–´ë–¤ ëª…ë ¹ì„ ì¨ì•¼ í• ê¹Œ?', () => {
                  messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                });
              });
            });
            break;
            
          case 'mountain-1':
            updateLocation('mountain', 80);
            this.addCodiMessage('ëª¬ìŠ¤í„°ì—ê²Œ ì„ ë¬¼ì„ ì£¼ê³  ê¸¸ì„ í†µê³¼í–ˆì–´! ğŸ', () => {
              this.addCodiMessage('ì‚°ì„ ì˜¤ë¥´ê¸° ì „ì— ìš°ë¦¬ ê°€ë°©ì— ëª‡ ê°œì˜ ë¬¼ê±´ì´ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì. ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë´!');
              messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
            });
            break;
            
          case 'mountain-2':
            this.addCodiMessage(`ê°€ë°©ì—ëŠ” ${this.bag.length}ê°œì˜ ë¬¼ê±´ì´ ìˆì–´! ğŸ”¢`, () => {
              this.addCodiMessage('ì‚°ì„ ì˜¤ë¥´ë ¤ë©´ ë¡œí”„ê°€ í•„ìš”í•´. ë¡œí”„ë¥¼ ê°€ë°©ì— ì¶”ê°€í•´ë³´ì!');
              // ì§ì ‘ ì…ë ¥ ëª¨ë“œë¡œ ì„¤ì •
              messageInput.placeholder = 'íŒŒì´ì¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
            });
            break;
            
          case 'final':
            updateLocation('end', 100);
            this.addCodiMessage('ì¶•í•˜í•´! ğŸ‰ ìš°ë¦¬ëŠ” ëª¨ë“  ì—¬í–‰ì„ ë§ˆì¹˜ê³  ì§‘ìœ¼ë¡œ ëŒì•„ì™”ì–´!', () => {
              this.addCodiMessage(`${this.playerName}ì•„(ì•¼), ì •ë§ ëŒ€ë‹¨í–ˆì–´! ì´ì œ ë„ˆëŠ” íŒŒì´ì¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì•Œê²Œ ëì–´!`, () => {
                this.addCodiMessage('ë‚´ê°€ë°©ì— appendë¡œ ë¬¼ê±´ ë„£ê¸°, removeë¡œ ë¬¼ê±´ ë¹¼ê¸°, lenìœ¼ë¡œ ê°œìˆ˜ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ ëª¨ë‘ ë°°ì› ì§€!', () => {
                  this.addCodiMessage('ì´ëŸ° íŒŒì´ì¬ ëª…ë ¹ì–´ë“¤ì€ ì‹¤ì œ í”„ë¡œê·¸ë˜ë°ì—ì„œë„ ë˜‘ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´. ì •ë§ ë©‹ì§„ ëª¨í—˜ì´ì—ˆì–´! ğŸ‘', () => {
                    this.addOptions(
                      ['ë‹¤ì‹œ ì‹œì‘í•˜ê¸° ğŸ”„'],
                      'ë‹¤ì‹œ ì‹œì‘í•˜ê¸° ğŸ”„',
                      'restart'
                    );
                  });
                });
              });
            });
            break;
            
          case 'restart':
            this.reset();
            break;
        }
      },
      
      // ê²Œì„ ì´ˆê¸°í™”
      reset: function() {
        this.playerName = '';
        this.bag = [];
        this.poppedItem = '';
        
        chatContainer.innerHTML = '';
        messageInput.disabled = false;
        messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
        sendBtn.disabled = false;
        
        this.updateBackpack();
        this.goToStage('intro');
      },
      
      // ë©”ì‹œì§€ ì…ë ¥ ì²˜ë¦¬
      handleInput: function(input) {
        if (!input.trim()) return;
        
        // ì…ë ¥ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬
        if (this.currentStage === 'intro') {
          this.playerName = input;
          this.addPlayerMessage(input);
          this.goToStage('start');
        } else if (this.currentStage === 'sea-2') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.append(\'ìˆ˜ì˜ë³µ\')', 'sea-monster');
        } else if (this.currentStage === 'sea-monster') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.remove(\'ì§€ë„\')', 'desert-1');
        } else if (this.currentStage === 'desert-1') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.append(\'ë¬¼\')', 'desert-2');
        } else if (this.currentStage === 'desert-2') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.append(\'ëª¨ì\')', 'desert-3');
        } else if (this.currentStage === 'desert-3') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.append(\'ì„ í¬ë¦¼\')', 'desert-storm');
        } else if (this.currentStage === 'desert-storm') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.remove', 'altar-append');
        } else if (this.currentStage === 'altar-insert') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.insert', 'monster-test');
        } else if (this.currentStage === 'monster-test') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.pop', 'mountain-1');
        } else if (this.currentStage === 'mountain-1') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'len(ë‚´ê°€ë°©)', 'mountain-2');
        } else if (this.currentStage === 'mountain-2') {
          this.addPlayerMessage(input);
          this.handleCustomInput(input, 'ë‚´ê°€ë°©.append(\'ë¡œí”„\')', 'final');
        }
      }
    };

    // ìœ„ì¹˜ë³„ ë°°ê²½ ë° ì•„ì´ì½˜
    const locations = {
      start: {
        bg: 'linear-gradient(to bottom, #E3E4E5 0%, #D4CECE 100%)',
        title: 'ğŸ‘‹ íŒŒì´ì¬ íƒí—˜ëŒ€ì˜ ì‹ ë¹„í•œ ì—¬í–‰',
        character: 'ğŸ¤–'
      },
      forest: {
        bg: 'linear-gradient(to bottom, #A8E6CF 0%, #7FDD9E 100%)',
        title: 'ğŸŒ² ì‹ ë¹„ì˜ ìˆ²',
        character: 'ğŸ¦'
      },
      sea: {
        bg: 'linear-gradient(to bottom, #87CEEB 0%, #4682B4 100%)',
        title: 'ğŸŒŠ ì‹ ë¹„ì˜ ë°”ë‹¤',
        character: 'ğŸ '
      },
      desert: {
        bg: 'linear-gradient(to bottom, #FFE5B4 0%, #FFA500 100%)',
        title: 'ğŸœï¸ ì‹ ë¹„ì˜ ì‚¬ë§‰',
        character: 'ğŸª'
      },
      altar: {
        bg: 'linear-gradient(to bottom, #B0E0E6 0%, #ADD8E6 100%)',
        title: 'â›©ï¸ ë¹„ë°€ì˜ ì œë‹¨',
        character: 'ğŸ—¿'
      },
      monster: {
        bg: 'linear-gradient(to bottom, #A9A9A9 0%, #696969 100%)',
        title: 'ğŸ‘¾ ëª¬ìŠ¤í„°ì˜ ì‹œí—˜',
        character: 'ğŸ‘¹'
      },
      mountain: {
        bg: 'linear-gradient(to bottom, #E0E0E0 0%, #999999 100%)',
        title: 'â›°ï¸ ì‹ ë¹„ì˜ ì‚°',
        character: 'ğŸ¦…'
      },
      end: {
        bg: 'linear-gradient(to bottom, #DDA0DD 0%, #9370DB 100%)',
        title: 'ğŸ† ëª¨í—˜ ì™„ë£Œ!',
        character: 'ğŸ‰'
      }
    };

    // ì•„ì´í…œ ì´ëª¨ì§€ ë§¤í•‘
    const itemEmojis = {
      'ë¬¼ë³‘': 'ğŸ’§',
      'ì§€ë„': 'ğŸ—ºï¸',
      'ì†ì „ë“±': 'ğŸ”¦',
      'ìˆ˜ì˜ë³µ': 'ğŸ©±',
      'ë¬¼': 'ğŸ’¦',
      'ëª¨ì': 'ğŸ‘’',
      'ì„ í¬ë¦¼': 'ğŸ§´',
      'ë¡œí”„': 'ğŸ§µ',
      'ë¬¼ì˜ ìˆ˜ì •': 'ğŸ’§',
      'ë¶ˆì˜ ìˆ˜ì •': 'ğŸ”¥',
      'ë°”ëŒì˜ ìˆ˜ì •': 'ğŸ’¨'
    };

    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    function updateLocation(locationKey, progress) {
      const location = locations[locationKey];
      locationBg.style.background = location.bg;
      locationTitle.textContent = location.title;
      locationCharacter.textContent = location.character;
      progressBar.style.width = `${progress}%`;
    }

    // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ì•„ë˜ë¡œ
    function scrollToBottom() {
      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 10);
    }

    // ë°±íŒ© í† ê¸€
    function toggleBackpack() {
      backpackContainer.classList.toggle('show');
      game.updateBackpack();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendBtn.addEventListener('click', () => {
      if (!messageInput.disabled && messageInput.value.trim()) {
        const input = messageInput.value.trim();
        messageInput.value = '';
        game.handleInput(input);
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !messageInput.disabled && messageInput.value.trim()) {
        const input = messageInput.value.trim();
        messageInput.value = '';
        game.handleInput(input);
      }
    });

    backpackBtn.addEventListener('click', toggleBackpack);

    // ê²Œì„ ì‹œì‘
    game.goToStage('intro');
  </script>
</body>
</html>
